Status: active
Owner: platform
Last Reviewed: 2026-02-20
Depends On: docs/spec-index.md, docs/provisioning-spec.md, docs/data-model.md
Supersedes: none

# Domain and Routing

This document specifies how Pressluft handles domains, preview URLs, TLS certificates, and HTTP routing for WordPress environments.

## Principles

- Every environment must be reachable via HTTP(S) immediately after creation, without requiring user DNS configuration.
- Custom domains are optional and can be attached or removed at any time.
- DNS record management is external to Pressluft. The platform never creates, modifies, or deletes DNS records on behalf of the operator or end user.
- Each node terminates its own TLS and serves its own traffic via Nginx. There is no central reverse proxy or load balancer.
- The control plane is never in the data path. All HTTP traffic flows directly to the node hosting the environment.

## Operator Configuration

Operators configure domain and routing settings through the control-plane configuration surface. These values are stored in the `settings` table (see `docs/data-model.md`). Public `/api/settings` endpoints are not part of the MVP OpenAPI contract.

### Required Settings

| Setting | Description | Example |
|---------|-------------|---------|
| `control_plane_domain` | Domain for accessing the Pressluft dashboard and API. Nullable during initial setup (accessible via IP:port). | `panel.example.com` |

### Optional Settings (Enable HTTPS Previews)

| Setting | Description | Example |
|---------|-------------|---------|
| `preview_domain` | Base domain for auto-generated preview URLs. Requires wildcard DNS. | `wp.example.com` |
| `dns01_provider` | DNS provider identifier for ACME DNS-01 challenges (for wildcard cert). Uses certbot DNS plugin identifiers as documented by Pressluft. | `cloudflare`, `hetzner`, `route53` |
| `dns01_credentials_json` | Provider-specific API credentials for DNS-01. Stored encrypted in the secrets store. | `{"CF_DNS_API_TOKEN": "..."}` |

When `preview_domain` is set, the operator must configure a wildcard DNS `A` record externally:

```
*.wp.example.com → <node public IP>
```

When `preview_domain` is not set, preview URLs fall back to sslip.io (see below).

## Preview URLs

Every environment receives a `preview_url` at creation time. This URL is deterministic, unique, and immediately routable without any DNS configuration by the end user.

### URL Generation

The preview URL is generated by the control plane at environment creation time using the following formula:

**With operator preview domain configured:**

```
https://{uuid8}.{preview_domain}
```

Example: `https://a1b2c3d4.wp.example.com`

**Without preview domain (sslip.io fallback):**

```
http://{uuid8}.{node_public_ip}.sslip.io
```

Example: `http://a1b2c3d4.203-0-113-5.sslip.io`

Where:
- `{uuid8}` is the first 8 characters of the environment's UUIDv4 `id`. This is globally unique within any realistic deployment.
- `{preview_domain}` is the operator-configured base domain.
- `{node_public_ip}` is the public IPv4 address of the node, with dots replaced by hyphens for sslip.io compatibility.

### sslip.io Fallback

[sslip.io](https://sslip.io) is a free DNS service that resolves hostnames containing embedded IP addresses to those addresses. For example, `anything.203-0-113-5.sslip.io` resolves to `203.0.113.5`.

This provides a working URL with zero DNS configuration. The trade-off is:

- HTTP only (no TLS). Let's Encrypt cannot issue certificates for sslip.io subdomains.
- Depends on a third-party DNS service. If sslip.io is unavailable, preview URLs using this fallback will not resolve.
- Not suitable for production use. This is a development convenience only.

When the operator later configures a `preview_domain`, existing environments retain their sslip.io preview URLs. New environments receive preview URLs under the configured domain.

### Preview URL Lifecycle

1. Generated at environment creation.
2. Stored in `environments.preview_url`.
3. Used as the canonical WordPress URL (`siteurl`, `home`) when no custom domain is attached.
4. Nginx server block created in the `site_create` / `env_create` Ansible playbook.
5. Immutable unless explicitly regenerated by the operator.

## Custom Domains

Custom domains are attached to individual environments via the `domains` table.

### Adding a Domain

1. User submits `POST /api/environments/:id/domains` with `{ hostname }`.
2. Control plane creates a `domains` record with `tls_status = pending`.
3. Control plane enqueues a `domain_add` job.
4. The `domain_add` Ansible playbook:
   a. Resolves the hostname via DNS and verifies it points to the node's public IP. If it does not, the playbook fails with a structured error.
   b. Creates an Nginx server block for the hostname, proxying to the environment's PHP-FPM pool.
   c. Provisions a TLS certificate via Let's Encrypt HTTP-01 using certbot.
   d. Updates WordPress `siteurl` and `home` options to the new domain (serialized-safe search-replace across the database, same logic as `docs/migration-spec.md` URL rewrite).
   e. Reloads Nginx.
5. On success, control plane updates `tls_status = active` and sets `primary_domain_id` on the environment (if this is the first domain or if it replaces the current primary).
6. On failure, `tls_status = failed`. The job follows standard retry logic (see `docs/job-execution.md`).

### DNS Verification

Before attempting TLS certificate issuance, the `domain_add` playbook must verify that the domain's DNS resolves to the target node's public IP address. This is a forward DNS lookup (A/AAAA record check), not a reverse lookup.

Verification logic:

1. Resolve the hostname to its IP address(es).
2. Compare against the node's `public_ip`.
3. If no match, fail the task with a clear error message: "DNS for {hostname} does not point to this server ({public_ip}). Please create an A record pointing {hostname} to {public_ip} and try again."

This prevents wasting ACME challenge attempts and provides actionable feedback to the user.

### Removing a Domain

1. User submits `DELETE /api/domains/:id`.
2. Control plane enqueues a `domain_remove` job.
3. The `domain_remove` Ansible playbook:
   a. Removes the Nginx server block for the hostname.
   b. Revokes or deletes the TLS certificate.
   c. If this was the primary domain, updates WordPress `siteurl` and `home` back to the environment's `preview_url` (serialized-safe search-replace).
   d. Reloads Nginx.
4. Control plane deletes the `domains` record and clears `primary_domain_id` if needed.

### Multiple Domains Per Environment

An environment may have multiple custom domains (e.g., `example.com` and `www.example.com`). Each gets its own Nginx server block and TLS certificate. Exactly one is designated as `primary_domain_id`, which is the canonical URL used for WordPress `siteurl`/`home`.

Non-primary domains should redirect (HTTP 301) to the primary domain. This is handled by the Nginx server block configuration.

## TLS Strategy

### Custom Domains: HTTP-01

Each custom domain receives its own TLS certificate from Let's Encrypt via the ACME HTTP-01 challenge.

- certbot runs on the node as the canonical ACME client for MVP.
- Nginx serves `/.well-known/acme-challenge/` for all domains (see `docs/provisioning-spec.md`).
- Certificates are stored on the node in the ACME client's default location.
- Renewal is handled by certbot's built-in systemd timer. This is configured during node provisioning and operates independently of the Pressluft job queue.

### Preview Wildcard: DNS-01

When the operator configures `preview_domain` and `dns01_provider`, a single wildcard certificate is issued for `*.{preview_domain}` via the ACME DNS-01 challenge.

- The ACME client uses the operator's DNS provider API credentials to create a `_acme-challenge` TXT record.
- A single certificate covers all preview subdomains.
- This certificate is provisioned during node provisioning (or when the operator first configures the preview domain) and renewed by the ACME client's built-in timer.
- The DNS-01 provider and credentials are passed to the provisioning playbook via extra-vars (credentials from the encrypted secrets store).

Supported DNS providers are those supported by the ACME client's DNS plugin ecosystem. For certbot, this includes Cloudflare, Hetzner, Route53, DigitalOcean, and others via `certbot-dns-*` plugins. The specific plugin is determined by the `dns01_provider` setting.

### sslip.io Fallback: No TLS

Preview URLs using the sslip.io fallback do not receive TLS certificates. They are served over plain HTTP. This is acceptable for development and initial setup but not for sharing with clients or production use.

### Control Plane TLS

The control plane's own TLS certificate is provisioned via Let's Encrypt HTTP-01 when the operator configures `control_plane_domain`. Before a domain is configured, the control plane is accessible via `http://{node_ip}:{port}`.

This is handled by a dedicated Nginx server block for the control plane, separate from environment server blocks.

## Nginx Server Block Model

Each node runs a single Nginx instance that serves all environments hosted on that node plus the control plane (if the node is the local node).

### Server Blocks

| Created By | Serves | TLS Source |
|------------|--------|------------|
| `node_provision` playbook | Control plane UI/API (if local node) | HTTP-01 cert for `control_plane_domain`, or plain HTTP if no domain configured |
| `site_create` / `env_create` playbook | Environment preview URL | Wildcard cert for `*.preview_domain`, or plain HTTP for sslip.io |
| `domain_add` playbook | Custom domain | HTTP-01 cert for the specific domain |

### Routing

Nginx matches incoming requests by the `Host` header against `server_name` directives in each server block. The matched block proxies to the appropriate PHP-FPM pool (for environments) or the Go control plane binary (for the UI/API).

A default server block returns HTTP 444 (connection closed) for requests that don't match any configured hostname. This prevents hostname spoofing and information leakage.

### Security: WAF Rules

Every environment server block includes the 7G Web Application Firewall rules:

```nginx
include /etc/nginx/conf.d/7g-firewall.conf;
include /etc/nginx/conf.d/7g-exclusions.conf;
```

These `include` directives are placed before any `location` blocks within the server block. This is not optional — all environments receive WAF protection uniformly. See `docs/provisioning-spec.md` for WAF rule details and the exclusion mechanism.

### FastCGI Page Caching

When `fastcgi_cache_enabled = 1` for an environment (see `docs/data-model.md`), the Nginx server block includes FastCGI caching directives. When disabled, the cache directives are omitted entirely.

Cache key:

```
$scheme$request_method$host$request_uri
```

Bypass rules (cache is skipped when any condition is true):

| Condition | Variable | Rationale |
|-----------|----------|-----------|
| POST requests | `$request_method = POST` | Form submissions must not be cached |
| Logged-in users | `$http_cookie ~* "wordpress_logged_in\|comment_author\|wp-postpass"` | Authenticated users see personalized content |
| WooCommerce sessions | `$http_cookie ~* "woocommerce_items_in_cart\|woocommerce_cart_hash\|wp_woocommerce_session"` | Cart, checkout, and account pages are dynamic |
| Admin and API paths | `$request_uri ~* "/wp-admin\|/wp-login\|/wp-cron\|/xmlrpc\|/wp-json"` | Admin, login, cron, XML-RPC, and REST API must not be cached |

Response header:

- `X-FastCGI-Cache` is added to all responses with value `HIT`, `MISS`, or `BYPASS`. This aids debugging and performance monitoring.

Cache purge:

- On `env_deploy`, `env_update`, `env_promote`, and `env_restore` operations, the Ansible playbook purges the FastCGI cache for the affected environment. This is implemented as an Ansible handler in the shared `nginx-cache-purge` role (see `docs/ansible-execution.md`).
- The `cache_purge` job type provides on-demand purge via the API (see `docs/api-contract.md`).

The `fastcgi_cache_path` directive is configured globally in the Nginx `http` block during node provisioning (see `docs/provisioning-spec.md`), not per server block.

### Server Block Lifecycle

- Server blocks are managed exclusively by Ansible playbooks. No manual Nginx configuration.
- Adding a domain creates a new server block file in `/etc/nginx/sites-enabled/`.
- Removing a domain deletes the corresponding server block file.
- All changes trigger an Nginx reload via Ansible handlers (not restart).

## Certificate Renewal

TLS certificates from Let's Encrypt expire after 90 days. Renewal is handled automatically:

- **certbot**: Installed during node provisioning. The `certbot.timer` systemd unit runs twice daily and renews certificates within 30 days of expiry. A post-renewal hook reloads Nginx.
- **Wildcard certificates**: Renewed via DNS-01 using the same provider credentials. certbot handles this automatically if the certificate was originally issued with DNS-01.

Certificate renewal operates independently of the Pressluft job queue. It is a node-level concern managed by the ACME client's built-in automation. The `tls_status` field on the `domains` table is not updated during routine renewal; it reflects the initial provisioning state.

If a renewal fails (e.g., DNS provider credentials revoked), certbot logs the failure. The control plane does not currently monitor renewal status. This is acceptable for MVP but should be revisited for production hardening (e.g., a periodic health check that verifies certificate expiry dates).

## Multi-Node Considerations (Post-MVP)

In multi-node deployments, each node has a different public IP. The wildcard DNS record for `*.preview_domain` can only point to one IP. Options for the future:

1. **Per-node preview subdomains**: `*.node1.wp.example.com`, `*.node2.wp.example.com`. Each node has its own wildcard DNS and cert.
2. **DNS round-robin or geo-DNS**: Multiple A records for `*.wp.example.com`. Unreliable for targeted routing.
3. **External load balancer**: A reverse proxy (e.g., Cloudflare, HAProxy) in front of nodes that routes by hostname. Breaks the "each node is self-contained" model.
4. **Unique preview domain per node**: Each node is assigned a subdomain from the operator's domain. Simplest extension of the single-node model.

The recommended approach for multi-node is option 1 or 4. This is explicitly deferred and will be specified when multi-node support is implemented.

## WordPress URL Rewrite on Domain Changes

When the canonical URL of an environment changes (domain added, domain removed, or preview URL regenerated), WordPress must be updated:

1. Update `wp_options` rows where `option_name` is `siteurl` or `home`.
2. Run a serialized-safe search-replace across all tables, replacing the old URL with the new URL.
3. Flush WordPress object cache and rewrite rules (`wp cache flush`, `wp rewrite flush`).
4. Purge the FastCGI page cache for the environment (clear cached responses that reference the old URL).

This is the same URL rewrite logic specified in `docs/migration-spec.md`, reused by the `domain_add` and `domain_remove` playbooks.

The URL rewrite is part of the Ansible playbook execution, not a separate job. It runs within the same job as the domain operation.

## Data Model Impact

This spec requires the following changes to `docs/data-model.md`:

### New: `settings` Table

See `docs/data-model.md` for the full table definition.

### Modified: `nodes` Table

Add `public_ip TEXT NULL` field. Populated during node registration or provisioning. Required for DNS verification and sslip.io fallback URL generation.

### Unchanged

- `domains` table: no changes.
- `environments.preview_url`: no changes to the field, but its generation logic is now specified above.

## Decisions Log

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Preview URL identifier | First 8 chars of environment UUID | Globally unique, opaque, no slug collision risk |
| Wildcard TLS method | DNS-01 via certbot DNS plugins | Only method that supports wildcard certs with Let's Encrypt |
| Custom domain TLS method | HTTP-01 | Simpler, no DNS provider API needed for end users |
| sslip.io as fallback | Yes, HTTP-only | Zero-config development convenience |
| Certificate renewal | ACME client built-in timer | Battle-tested, no custom job queue integration needed |
| DNS verification | Forward lookup before TLS attempt | Fail fast, actionable error messages |
| Central reverse proxy | No | Contradicts per-node isolation model; unnecessary for single-node MVP |
| Multi-node routing | Deferred | Single-node MVP; will be specified separately |
| Control plane TLS | HTTP-01, configured post-install via UI | IP:port access on first boot; domain added later |
