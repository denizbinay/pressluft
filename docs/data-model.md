# Data Model

This document defines the MVP database schema as the source of truth for Pressluft. It assumes SQLite for the control plane database.

## Conventions

- IDs: `TEXT` UUIDv4 strings generated by the control plane.
- Timestamps: `TEXT` in UTC ISO-8601 (e.g. `2026-02-18T12:34:56Z`).
- Booleans: `INTEGER` where `0` = false, `1` = true.
- JSON payloads: `TEXT` containing JSON.
- Optimistic concurrency: `state_version INTEGER NOT NULL DEFAULT 1` on mutable resources.

## Enums

- site_status: `active | cloning | deploying | restoring | failed`
- environment_type: `production | staging | clone`
- environment_status: `active | cloning | deploying | restoring | failed`
- node_status: `active | provisioning | unreachable | decommissioned`
- release_source_type: `git | upload`
- release_health_status: `unknown | healthy | unhealthy`
- backup_scope: `db | files | full`
- backup_status: `pending | running | completed | failed | expired`
- storage_type: `s3`
- tls_status: `pending | active | failed | disabled`
- job_status: `queued | running | succeeded | failed | cancelled`
- user_role: `admin`
- promotion_preset: `content-protect | commerce-protect`
- drift_status: `unknown | clean | drifted`

## Tables

### sites

- id TEXT PRIMARY KEY
- name TEXT NOT NULL
- slug TEXT NOT NULL UNIQUE
- status TEXT NOT NULL
- primary_environment_id TEXT NULL REFERENCES environments(id)
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL
- state_version INTEGER NOT NULL DEFAULT 1

Rules:
- One site can have many environments.
- Exactly one production environment per site is enforced at the application layer.

### environments

- id TEXT PRIMARY KEY
- site_id TEXT NOT NULL REFERENCES sites(id)
- name TEXT NOT NULL
- slug TEXT NOT NULL
- environment_type TEXT NOT NULL
- status TEXT NOT NULL
- node_id TEXT NOT NULL REFERENCES nodes(id)
- source_environment_id TEXT NULL REFERENCES environments(id)
- promotion_preset TEXT NOT NULL
- preview_url TEXT NOT NULL
- primary_domain_id TEXT NULL REFERENCES domains(id)
- current_release_id TEXT NULL REFERENCES releases(id)
- drift_status TEXT NOT NULL
- drift_checked_at TEXT NULL
- last_drift_check_id TEXT NULL REFERENCES drift_checks(id)
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL
- state_version INTEGER NOT NULL DEFAULT 1

Indexes:
- UNIQUE(site_id, slug)

Rules:
- `source_environment_id` is set for clones/staging created from another environment.
- `current_release_id` must reference a release for this environment when status is `active`.

### nodes

- id TEXT PRIMARY KEY
- name TEXT NOT NULL
- hostname TEXT NOT NULL
- public_ip TEXT NULL
- ssh_port INTEGER NOT NULL
- ssh_user TEXT NOT NULL
- status TEXT NOT NULL
- is_local INTEGER NOT NULL
- last_seen_at TEXT NULL
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL
- state_version INTEGER NOT NULL DEFAULT 1

Rules:
- The host running the control plane is registered as a node with `is_local = 1`.
- `public_ip` is the node's public IPv4 address. Used for DNS verification and sslip.io fallback preview URLs. Populated during node registration or provisioning. See `docs/domain-and-routing.md`.

### releases

- id TEXT PRIMARY KEY
- environment_id TEXT NOT NULL REFERENCES environments(id)
- source_type TEXT NOT NULL
- source_ref TEXT NOT NULL
- path TEXT NOT NULL
- health_status TEXT NOT NULL
- notes TEXT NULL
- created_at TEXT NOT NULL

Rules:
- Releases are immutable once created.
- `source_type` uses `release_source_type`.

### backups

- id TEXT PRIMARY KEY
- environment_id TEXT NOT NULL REFERENCES environments(id)
- backup_scope TEXT NOT NULL
- status TEXT NOT NULL
- storage_type TEXT NOT NULL
- storage_path TEXT NOT NULL
- retention_until TEXT NOT NULL
- checksum TEXT NULL
- size_bytes INTEGER NULL
- created_at TEXT NOT NULL
- completed_at TEXT NULL

Rules:
- `storage_type` is `s3` for MVP.
- `retention_until` is calculated at creation time.

### domains

- id TEXT PRIMARY KEY
- environment_id TEXT NOT NULL REFERENCES environments(id)
- hostname TEXT NOT NULL UNIQUE
- tls_status TEXT NOT NULL
- tls_issuer TEXT NOT NULL
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL

Rules:
- `tls_issuer` is `letsencrypt` for MVP.

### jobs

- id TEXT PRIMARY KEY
- job_type TEXT NOT NULL
- status TEXT NOT NULL
- site_id TEXT NOT NULL REFERENCES sites(id)
- environment_id TEXT NULL REFERENCES environments(id)
- node_id TEXT NULL REFERENCES nodes(id)
- payload_json TEXT NOT NULL
- attempt_count INTEGER NOT NULL
- max_attempts INTEGER NOT NULL DEFAULT 3
- run_after TEXT NULL
- locked_at TEXT NULL
- locked_by TEXT NULL
- started_at TEXT NULL
- finished_at TEXT NULL
- error_code TEXT NULL
- error_message TEXT NULL
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL

Indexes:
- (status, run_after)
- (site_id, status)

Rules:
- Jobs that mutate infrastructure must set `node_id`.

### users

- id TEXT PRIMARY KEY
- email TEXT NOT NULL UNIQUE
- display_name TEXT NOT NULL
- role TEXT NOT NULL
- password_hash TEXT NOT NULL
- is_active INTEGER NOT NULL
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL

Rules:
- Only one user with role `admin` is required for MVP.

### auth_sessions

- id TEXT PRIMARY KEY
- user_id TEXT NOT NULL REFERENCES users(id)
- session_token TEXT NOT NULL UNIQUE
- expires_at TEXT NOT NULL
- created_at TEXT NOT NULL
- revoked_at TEXT NULL

### drift_checks

- id TEXT PRIMARY KEY
- environment_id TEXT NOT NULL REFERENCES environments(id)
- promotion_preset TEXT NOT NULL
- status TEXT NOT NULL
- db_checksums_json TEXT NULL
- file_checksums_json TEXT NULL
- checked_at TEXT NOT NULL

Rules:
- Drift checks are immutable records.
- `status` uses `drift_status`.

### audit_logs

- id TEXT PRIMARY KEY
- user_id TEXT NOT NULL REFERENCES users(id)
- action TEXT NOT NULL
- resource_type TEXT NOT NULL
- resource_id TEXT NOT NULL
- result TEXT NOT NULL
- created_at TEXT NOT NULL

### settings

- key TEXT PRIMARY KEY
- value TEXT NOT NULL
- updated_at TEXT NOT NULL

Rules:
- Key-value store for operator-level configuration.
- Known keys for MVP:
  - `control_plane_domain`: Domain for the Pressluft dashboard/API. Nullable (IP:port access when unset).
  - `preview_domain`: Base domain for preview URLs (e.g., `wp.example.com`). Nullable (sslip.io fallback when unset).
  - `dns01_provider`: DNS provider identifier for ACME DNS-01 wildcard cert (e.g., `cloudflare`, `hetzner`, `route53`). Required when `preview_domain` is set for HTTPS previews.
  - `dns01_credentials_json`: Encrypted JSON containing provider-specific API credentials. Stored in the secrets store at `/var/lib/pressluft/secrets`, referenced by this key.
- See `docs/domain-and-routing.md` for full usage.
